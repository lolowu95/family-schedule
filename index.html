<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家庭日程记录</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', 'PingFang SC', Arial, sans-serif; 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 20px; 
            background: linear-gradient(135deg, #a1c4fd, #c2e9fb); 
            min-height: 100vh; 
            color: #2c3e50; 
            position: relative; 
            overflow-x: hidden; 
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 70%);
            animation: backgroundPulse 15s infinite ease-in-out;
            z-index: -1;
        }
        @keyframes backgroundPulse {
            0%, 100% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.2); opacity: 0.5; }
        }
        h1 { 
            text-align: center; 
            font-size: 2.8em; 
            margin-bottom: 30px; 
            color: #1e3a8a; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2); 
            animation: fadeInDown 1s ease-out; 
        }
        @keyframes fadeInDown {
            0% { opacity: 0; transform: translateY(-20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .password-container, .login-container, .schedule-form { 
            background: rgba(255, 255, 255, 0.95); 
            padding: 25px; 
            border-radius: 15px; 
            box-shadow: 0 6px 20px rgba(0,0,0,0.15); 
            margin-bottom: 30px; 
            transition: transform 0.3s ease, box-shadow 0.3s ease; 
            animation: fadeIn 0.8s ease-out; 
        }
        .password-container:hover, .login-container:hover, .schedule-form:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.25); 
        }
        @keyframes fadeIn {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }
        .form-group { 
            margin-bottom: 20px; 
        }
        label { 
            display: flex; 
            align-items: center; 
            margin-bottom: 8px; 
            color: #34495e; 
            font-weight: 600; 
            font-size: 1.1em; 
        }
        label i { 
            margin-right: 8px; 
        }
        input, select { 
            width: 100%; 
            padding: 12px 15px; 
            border: 2px solid #dfe6e9; 
            border-radius: 8px; 
            font-size: 1em; 
            transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease; 
            background: #f8f9fa; 
            position: relative; 
            z-index: 1; 
        }
        select { 
            appearance: none; 
            -webkit-appearance: none; 
            -moz-appearance: none; 
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="%2334495e"><path d="M7 10l-5-5 1.41-1.41L7 7.17l4.59-4.58L12 5l-5 5z"/></svg>') no-repeat right 10px center; 
        }
        input:focus, select:focus { 
            outline: none; 
            border-color: #1e90ff; 
            box-shadow: 0 0 8px rgba(30, 144, 255, 0.3); 
            transform: scale(1.02); 
        }
        .datetime-group { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .datetime-group input[type="text"] { 
            flex-grow: 1; 
        }
        button { 
            background: linear-gradient(45deg, #1e90ff, #00c4ff); 
            color: white; 
            padding: 12px 25px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1em; 
            font-weight: 600; 
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            width: 100%; 
            margin-top: 10px; 
            position: relative; 
            overflow: hidden; 
        }
        button:hover { 
            background: linear-gradient(45deg, #187bcd, #00aaff); 
            transform: translateY(-2px); 
            box-shadow: 0 4px 15px rgba(30, 144, 255, 0.4); 
        }
        button::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }
        button:active::after {
            width: 300px;
            height: 300px;
        }
        .error-message { 
            color: #e74c3c; 
            font-size: 0.9em; 
            margin-top: 5px; 
            display: none; 
        }
        .schedule-list, .log-list { 
            background: rgba(255, 255, 255, 0.95); 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 6px 20px rgba(0,0,0,0.15); 
            margin-bottom: 30px; 
            animation: fadeIn 0.8s ease-out; 
        }
        .schedule-list h2, .log-list h2 { 
            color: #1e3a8a; 
            margin: 0 0 20px 0; 
            font-size: 1.8em; 
            border-bottom: 2px solid #ecf0f1; 
            padding-bottom: 10px; 
        }
        .filter-group { 
            margin-bottom: 20px; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            align-items: center; 
        }
        .filter-group select { 
            width: auto; 
            min-width: 150px; 
        }
        .view-toggle { 
            display: flex; 
            gap: 10px; 
        }
        .view-toggle button { 
            width: auto; 
            padding: 8px 15px; 
            font-size: 0.9em; 
        }
        .view-toggle button.active { 
            background: linear-gradient(45deg, #187bcd, #00aaff); 
        }
        .timeline { 
            position: relative; 
            padding-left: 50px; 
            scroll-behavior: smooth; 
        }
        .timeline::before { 
            content: ''; 
            position: absolute; 
            left: 25px; 
            top: 0; 
            bottom: 0; 
            width: 3px; 
            background: linear-gradient(to bottom, #1e90ff, #00c4ff); 
        }
        .timeline-item { 
            position: relative; 
            margin-bottom: 30px; 
            background: #f9fbfc; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 3px 10px rgba(0,0,0,0.1); 
            transition: transform 0.3s ease, background 0.3s ease, box-shadow 0.3s ease; 
            display: flex; 
            align-items: flex-start; 
            gap: 10px; 
            animation: slideIn 0.5s ease-out; 
        }
        @keyframes slideIn {
            0% { opacity: 0; transform: translateX(-20px); }
            100% { opacity: 1; transform: translateX(0); }
        }
        .timeline-item:hover { 
            transform: translateX(5px); 
            background: #e6f0fa; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
        }
        .timeline-item:active { 
            transform: scale(0.98); 
        }
        .timeline-item::before { 
            content: ''; 
            position: absolute; 
            left: -38px; 
            top: 20px; 
            width: 14px; 
            height: 14px; 
            background: #1e90ff; 
            border-radius: 50%; 
            border: 3px solid white; 
            transition: transform 0.3s ease; 
        }
        .timeline-item:hover::before { 
            transform: scale(1.2); 
        }
        .timeline-item.completed::before { 
            background: #2ecc71; 
        }
        .timeline-item .avatar { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            color: white; 
            font-weight: bold; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            flex-shrink: 0; 
            font-size: 1.2em; 
            transition: transform 0.3s ease; 
        }
        .timeline-item:hover .avatar { 
            transform: rotate(360deg); 
        }
        .timeline-item .content { 
            flex-grow: 1; 
        }
        .timeline-item .date-time { 
            color: #7f8c8d; 
            font-size: 0.95em; 
            margin-bottom: 5px; 
        }
        .timeline-item .event { 
            color: #2c3e50; 
            font-size: 1.2em; 
            font-weight: bold; 
            margin-bottom: 5px; 
        }
        .timeline-item .added-by { 
            color: #e67e22; 
            font-size: 0.85em; 
        }
        .timeline-item .actions { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        .timeline-item .delete-btn { 
            background: #e74c3c; 
            color: white; 
            border: none; 
            padding: 6px 12px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 0.85em; 
            transition: background 0.3s ease, transform 0.2s ease; 
        }
        .timeline-item .delete-btn:hover { 
            background: #c0392b; 
            transform: scale(1.1); 
        }
        .timeline-item .checkbox { 
            transform: scale(1.1); 
            transition: transform 0.2s ease; 
        }
        .timeline-item .checkbox:hover { 
            transform: scale(1.3); 
        }
        .timeline-item.completed .event { 
            text-decoration: line-through; 
            color: #7f8c8d; 
        }
        .calendar-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        }
        .calendar-header button { 
            width: auto; 
            padding: 8px 15px; 
            font-size: 0.9em; 
        }
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 5px; 
        }
        .calendar-day { 
            background: #f9fbfc; 
            padding: 5px; 
            border-radius: 5px; 
            height: 140px; 
            overflow-y: auto; 
            border: 1px solid #dfe6e9; 
            font-size: 0.9em; 
            position: relative; 
            transition: transform 0.2s ease, background 0.3s ease; 
        }
        .calendar-day.header { 
            background: #1e90ff; 
            color: white; 
            text-align: center; 
            font-weight: bold; 
            height: 40px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .calendar-day.empty { 
            background: #ecf0f1; 
        }
        .calendar-day.today { 
            border: 2px solid #1e90ff; 
            background: #e6f0fa; 
        }
        .calendar-day:hover:not(.empty):not(.header) { 
            transform: scale(1.05); 
            background: #e6f0fa; 
        }
        .calendar-day .day-number { 
            position: absolute; 
            top: 5px; 
            left: 5px; 
            font-weight: bold; 
            color: #2c3e50; 
        }
        .calendar-event { 
            background: #f9fbfc; 
            padding: 4px; 
            margin: 2px 0; 
            border-radius: 5px; 
            font-size: 0.85em; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            position: relative; 
            top: 20px; 
            cursor: pointer; 
            transition: background 0.3s ease, transform 0.2s ease; 
        }
        .calendar-event:hover { 
            background: #e6f0fa; 
            transform: translateY(-2px); 
        }
        .calendar-event:active { 
            transform: scale(0.98); 
        }
        .calendar-event.completed { 
            background: #e6f0fa; 
            color: #7f8c8d; 
        }
        .calendar-event.completed .event-text { 
            text-decoration: line-through; 
        }
        .calendar-event .avatar { 
            width: 24px; 
            height: 24px; 
            font-size: 0.8em; 
            flex-shrink: 0; 
            border-radius: 50%; 
            color: white; 
            font-weight: bold; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: transform 0.3s ease; 
        }
        .calendar-event:hover .avatar { 
            transform: rotate(360deg); 
        }
        .calendar-event .content { 
            flex-grow: 1; 
            min-width: 0; 
        }
        .calendar-event .event-text { 
            color: #34495e; 
            font-size: 0.85em; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            margin-bottom: 2px; 
        }
        .calendar-event .added-by { 
            color: #e67e22; 
            font-size: 0.75em; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .calendar-day.selected {
            background-color: #a0c4ff;
        }
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 1000; 
            opacity: 0; 
            transition: opacity 0.3s ease; 
        }
        .modal.show { 
            display: block; 
            opacity: 1; 
        }
        .modal-content { 
            background: white; 
            padding: 15px; 
            border-radius: 10px; 
            width: 90%; 
            max-width: 600px; 
            max-height: 80vh; 
            overflow-y: auto; 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%) scale(0.9); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
            transition: transform 0.3s ease; 
        }
        .modal.show .modal-content { 
            transform: translate(-50%, -50%) scale(1); 
        }
        .modal-content h3 { 
            margin-bottom: 10px; 
            color: #1e3a8a; 
            font-size: 1.2em; 
        }
        .modal-content .form-group { 
            margin-bottom: 10px; 
        }
        .modal-content button { 
            width: 48%; 
            margin: 0 1%; 
            padding: 8px; 
            font-size: 0.9em; 
        }
        .modal-content button.cancel { 
            background: #e74c3c; 
        }
        .modal-content button.cancel:hover { 
            background: #c0392b; 
        }
        .calendar-month { 
            margin-bottom: 20px; 
        }
        .calendar-month h4 { 
            color: #1e3a8a; 
            margin-bottom: 10px; 
            text-align: center; 
        }
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 5px; 
        }
        .calendar-day { 
            background: #f9fbfc; 
            padding: 5px; 
            border-radius: 5px; 
            text-align: center; 
            border: 1px solid #dfe6e9; 
            font-size: 0.9em; 
            cursor: pointer; 
            transition: background 0.3s ease, transform 0.2s ease; 
            touch-action: none;
        }
        .calendar-day.header { 
            background: #1e90ff; 
            color: white; 
            font-weight: bold; 
            height: 30px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .calendar-day.empty { 
            background: #ecf0f1; 
            cursor: default; 
        }
        .calendar-day.today { 
            border: 2px solid #1e90ff; 
            background: #e6f0fa; 
        }
        .calendar-day.selected { 
            background-color: #a0c4ff; 
        }
        .calendar-day:hover:not(.empty):not(.header) { 
            background: #e6f0fa; 
            transform: scale(1.1); 
        }
        .schedule-detail-modal .modal-content { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }
        .schedule-detail-modal .detail-item { 
            display: flex; 
            align-items: flex-start; 
            gap: 10px; 
        }
        .schedule-detail-modal .avatar { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            color: white; 
            font-weight: bold; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            flex-shrink: 0; 
            font-size: 1.2em; 
        }
        .schedule-detail-modal .content { 
            flex-grow: 1; 
        }
        .schedule-detail-modal .time-range { 
            color: #7f8c8d; 
            font-size: 0.95em; 
            margin-bottom: 5px; 
        }
        .schedule-detail-modal .event-text { 
            color: #2c3e50; 
            font-size: 1.2em; 
            font-weight: bold; 
            margin-bottom: 5px; 
        }
        .schedule-detail-modal .added-by { 
            color: #e67e22; 
            font-size: 0.85em; 
        }
        .schedule-detail-modal .actions { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            margin-top: 10px; 
        }
        .schedule-detail-modal .delete-btn { 
            background: #e74c3c; 
            color: white; 
            border: none; 
            padding: 6px 12px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 0.85em; 
            transition: background 0.3s ease; 
        }
        .schedule-detail-modal .delete-btn:hover { 
            background: #c0392b; 
        }
        .schedule-detail-modal .checkbox { 
            transform: scale(1.1); 
        }
        .schedule-detail-modal.completed .event-text { 
            text-decoration: line-through; 
            color: #7f8c8d; 
        }
        .log-item { 
            padding: 10px; 
            border-bottom: 1px solid #ecf0f1; 
            font-size: 0.95em; 
            color: #34495e; 
            transition: background 0.3s ease; 
        }
        .log-item:last-child { 
            border-bottom: none; 
        }
        .log-item:hover { 
            background: #f0f4f8; 
        }
        .log-list .logs-container { 
            max-height: none; 
            transition: max-height 0.3s ease; 
        }
        .log-list .logs-container.collapsed .log-item:nth-child(n+6) { 
            display: none; 
        }
        .log-list .toggle-btn { 
            background: linear-gradient(45deg, #1e90ff, #00c4ff); 
            color: white; 
            padding: 8px 15px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 0.9em; 
            font-weight: 600; 
            margin-top: 10px; 
            display: inline-flex; 
            align-items: center; 
            gap: 5px; 
            transition: background 0.3s ease, transform 0.2s ease; 
            width: auto; 
        }
        .log-list .toggle-btn:hover { 
            background: linear-gradient(45deg, #187bcd, #00aaff); 
            transform: scale(1.05); 
        }
        @media (max-width: 600px) { 
            body { 
                padding: 10px; 
                background: linear-gradient(135deg, #a1c4fd, #c2e9fb); 
            } 
            h1 { 
                font-size: 2em; 
                margin-bottom: 20px; 
            } 
            .password-container, .login-container, .schedule-form, .schedule-list, .log-list { 
                padding: 15px; 
                border-radius: 10px; 
                box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            } 
            .form-group label { 
                font-size: 0.95em; 
            } 
            input, select, button { 
                font-size: 0.9em; 
                padding: 10px; 
                border-radius: 6px; 
            } 
            button { 
                padding: 10px 20px; 
            } 
            .timeline { 
                padding-left: 40px; 
                -webkit-overflow-scrolling: touch;
            } 
            .timeline::before { 
                left: 20px; 
            } 
            .timeline-item { 
                padding: 15px; 
                gap: 8px; 
                border-radius: 8px; 
            } 
            .timeline-item::before { 
                left: -32px; 
                width: 12px; 
                height: 12px; 
            } 
            .timeline-item .avatar { 
                width: 30px; 
                height: 30px; 
                font-size: 1em; 
            } 
            .timeline-item .date-time { 
                font-size: 0.85em; 
            } 
            .timeline-item .event { 
                font-size: 1.1em; 
            } 
            .timeline-item .added-by { 
                font-size: 0.75em; 
            } 
            .timeline-item .delete-btn { 
                padding: 5px 10px; 
                font-size: 0.8em; 
            } 
            .calendar-grid { 
                grid-template-columns: repeat(7, 1fr); 
                gap: 3px; 
            } 
            .calendar-day { 
                padding: 3px; 
                height: 100px; 
                font-size: 0.8em; 
                border-radius: 4px; 
            } 
            .calendar-day.header { 
                height: 30px; 
                font-size: 0.9em; 
            } 
            .calendar-day .day-number { 
                font-size: 0.9em; 
            } 
            .calendar-event { 
                padding: 3px; 
                font-size: 0.75em; 
                gap: 4px; 
                border-radius: 4px; 
            } 
            .calendar-event .avatar { 
                width: 20px; 
                height: 20px; 
                font-size: 0.7em; 
            } 
            .calendar-event .event-text { 
                font-size: 0.75em; 
            } 
            .calendar-event .added-by { 
                font-size: 0.65em; 
            } 
            .log-item { 
                font-size: 0.85em; 
                padding: 8px; 
            } 
            .datetime-group { 
                flex-direction: column; 
                align-items: stretch; 
            } 
            .datetime-group button { 
                width: 100%; 
            } 
            .modal { 
                padding: 10px; 
            } 
            .modal-content { 
                width: 95%; 
                max-width: 350px; 
                max-height: 85vh; 
                padding: 10px; 
                border-radius: 8px; 
            } 
            .modal-content h3 { 
                font-size: 1em; 
            } 
            .modal-content button { 
                font-size: 0.8em; 
                padding: 6px; 
            } 
            .calendar-day { 
                padding: 2px; 
                font-size: 0.8em; 
            } 
            .calendar-day.header { 
                font-size: 0.8em; 
            } 
            .schedule-detail-modal .modal-content { 
                max-width: 300px; 
            } 
            .schedule-detail-modal .avatar { 
                width: 30px; 
                height: 30px; 
                font-size: 1em; 
            } 
            .schedule-detail-modal .time-range { 
                font-size: 0.85em; 
            } 
            .schedule-detail-modal .event-text { 
                font-size: 1.1em; 
            } 
            .schedule-detail-modal .added-by { 
                font-size: 0.75em; 
            } 
            .schedule-detail-modal .delete-btn { 
                padding: 5px 10px; 
                font-size: 0.8em; 
            } 
            .log-list .toggle-btn { 
                padding: 6px 12px; 
                font-size: 0.8em; 
            } 
        }
    </style>
</head>
<body>
    <h1><i class="fas fa-calendar-alt"></i> 家庭日程记录</h1>

    <!-- 密码验证区域 -->
    <div class="password-container" id="passwordContainer">
        <div class="form-group">
            <label><i class="fas fa-lock"></i> 请输入访问密码</label>
            <input type="password" id="accessPassword" placeholder="请输入密码" required autofocus>
            <div class="error-message" id="passwordError">密码错误，请重试！</div>
        </div>
        <button id="verifyButton"><i class="fas fa-sign-in-alt"></i> 验证</button>
    </div>

    <!-- 登录区域 -->
    <div class="login-container" id="loginContainer" style="display: none;">
        <div class="form-group">
            <label><i class="fas fa-user"></i> 选择用户</label>
            <select id="username" autofocus>
                <option value="" disabled selected>请选择</option>
                <option value="吴乐乐">吴乐乐</option>
                <option value="张宝宝">张宝宝</option>
                <option value="冯妈妈">冯妈妈</option>
                <option value="懒宝">懒宝</option>
            </select>
        </div>
        <button id="loginBtn"><i class="fas fa-sign-in-alt"></i> 登录</button>
    </div>

    <!-- 输入区域 -->
    <div class="schedule-form" id="scheduleForm" style="display: none;">
        <div class="form-group">
            <label><i class="fas fa-calendar"></i> 时间段</label>
            <div class="datetime-group">
                <input type="text" id="datetimeDisplay" readonly placeholder="点击选择时间段">
                <button id="openDatePickerBtn"><i class="fas fa-calendar-alt"></i> 选择时间段</button>
            </div>
        </div>
        <div class="form-group">
            <label><i class="fas fa-sticky-note"></i> 事件</label>
            <input type="text" id="event" placeholder="请输入事件" required>
        </div>
        <div class="form-group">
            <label><i class="fas fa-user"></i> 添加者</label>
            <input type="text" id="addedBy" value="" readonly>
        </div>
        <button id="addScheduleBtn"><i class="fas fa-plus"></i> 添加日程</button>
        <button id="logoutBtn" style="background: #e74c3c; margin-top: 10px;"><i class="fas fa-sign-out-alt"></i> 登出</button>
    </div>

    <!-- 自定义日期选择器弹窗 -->
    <div class="modal" id="datePickerModal">
        <div class="modal-content">
            <h3>选择时间段</h3>
            <div class="calendar-header">
                <button id="prevModalMonthBtn">上一月</button>
                <button id="nextModalMonthBtn">下一月</button>
            </div>
            <div id="modalCalendarGrid"></div>
            <button id="confirmRangeBtn">确认</button>
            <button class="cancel" id="closeDatePickerBtn">取消</button>
        </div>
    </div>

    <!-- 日程详情模态框 -->
    <div class="modal schedule-detail-modal" id="scheduleDetailModal">
        <div class="modal-content">
            <h3>日程详情</h3>
            <div id="scheduleDetailContent"></div>
            <button class="cancel" id="closeScheduleDetailBtn">关闭</button>
        </div>
    </div>

    <!-- 日程列表 -->
    <div class="schedule-list" id="scheduleList" style="display: none;">
        <h2><i class="fas fa-list"></i> 日程列表</h2>
        <div class="filter-group">
            <label><i class="fas fa-filter"></i> 筛选用户</label>
            <select id="filterUser" onchange="filterSchedules()">
                <option value="all">全部</option>
                <option value="吴乐乐">吴乐乐</option>
                <option value="张宝宝">张宝宝</option>
                <option value="冯妈妈">冯妈妈</option>
                <option value="懒宝">懒宝</option>
            </select>
            <div class="view-toggle">
                <button id="calendarViewBtn">日历视图</button>
                <button id="timelineViewBtn" class="active">时间线视图</button>
            </div>
        </div>
        <div id="calendarView" style="display: none;">
            <div class="calendar-header">
                <button id="prevMonthBtn">上一月</button>
                <h3 id="calendarMonth"></h3>
                <button id="nextMonthBtn">下一月</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>
        <div id="timelineView" class="timeline" style="display: block;"></div>
    </div>

    <!-- 操作日志 -->
    <div class="log-list" id="logList" style="display: none;">
        <h2><i class="fas fa-history"></i> 操作日志</h2>
        <div id="logs" class="logs-container collapsed"></div>
        <button id="toggleLogsBtn" class="toggle-btn" style="display: none;">
            <i class="fas fa-chevron-down"></i> 查看更多
        </button>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script>
        let currentUser = null;
        let schedules = [];
        let logs = [];
        let db, schedulesRef, logsRef, auth;
        let currentView = 'timeline';
        let currentMonth = new Date();
        let modalStartMonth = new Date();
        let modalIsSelecting = false;
        let modalSelectedStart = null;
        let modalSelectedEnd = null;
        let isLogsExpanded = false;

        const firebaseConfig = {
            apiKey: "AIzaSyCXv-VzsLyRZ6E4m7AnFUXv3_tVoedegSE",
            authDomain: "familidayli.firebaseapp.com",
            projectId: "familidayli",
            storageBucket: "familidayli.firebasestorage.app",
            messagingSenderId: "577012068660",
            appId: "1:577012068660:web:957bffcccfdc425fdb3561",
            databaseURL: "https://familidayli-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        // 初始化 Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.database();
            schedulesRef = db.ref('schedules');
            logsRef = db.ref('logs');
            console.log("Firebase 初始化成功");
        } catch (error) {
            console.error("Firebase 初始化失败:", error);
            alert("Firebase 初始化失败: " + error.message);
        }

        // 验证日期是否有效
        function isValidDate(dateString) {
            const date = new Date(dateString);
            return !isNaN(date.getTime());
        }

        // 清理系统日程
        function cleanSystemSchedules() {
            schedulesRef.once('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    Object.keys(data).forEach(key => {
                        const schedule = data[key];
                        if (schedule.user === '系统') {
                            schedulesRef.child(key).remove().then(() => {
                                console.log(`已删除系统日程: ${schedule.event}`);
                                logAction('删除系统日程', `事件: ${schedule.event}, 时间: ${new Date(schedule.startDatetime).toLocaleString('zh-CN')} 至 ${new Date(schedule.endDatetime).toLocaleString('zh-CN')}`);
                            }).catch((error) => {
                                console.error(`删除系统日程失败: ${schedule.event}`, error);
                            });
                        }
                    });
                }
            });
        }

        // 密码验证
        function verifyPassword() {
            console.log("verifyPassword 函数被调用");
            const inputPassword = document.getElementById('accessPassword').value;
            const passwordError = document.getElementById('passwordError');
            const email = "641812032@qq.com";

            auth.signInWithEmailAndPassword(email, inputPassword)
                .then((userCredential) => {
                    localStorage.setItem('accessVerified', 'true');
                    document.getElementById('passwordContainer').style.display = 'none';
                    document.getElementById('loginContainer').style.display = 'block';
                    passwordError.style.display = 'none';
                    loadSchedules();
                    loadLogs();
                })
                .catch((error) => {
                    console.error("密码验证失败:", error);
                    passwordError.textContent = "密码错误，请重试！";
                    passwordError.style.display = 'block';
                });
        }

        // 页面加载
        window.onload = function() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    localStorage.setItem('accessVerified', 'true');
                    document.getElementById('passwordContainer').style.display = 'none';
                    document.getElementById('loginContainer').style.display = 'block';
                    loadSchedules();
                    loadLogs();
                } else {
                    localStorage.removeItem('accessVerified');
                    document.getElementById('passwordContainer').style.display = 'block';
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('scheduleForm').style.display = 'none';
                    document.getElementById('scheduleList').style.display = 'none';
                    document.getElementById('logList').style.display = 'none';
                }

                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowEnd = new Date(tomorrow);
                tomorrowEnd.setHours(tomorrow.getHours() + 1);
                document.getElementById('datetimeDisplay').value = `${tomorrow.toLocaleString('zh-CN', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                })} 至 ${tomorrowEnd.toLocaleString('zh-CN', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                })}`;
                document.getElementById('datetimeDisplay').dataset.start = tomorrow.toISOString();
                document.getElementById('datetimeDisplay').dataset.end = tomorrowEnd.toISOString();
            });
        };

        // 绑定事件
        document.addEventListener('DOMContentLoaded', function() {
            const verifyButton = document.getElementById('verifyButton');
            if (verifyButton) {
                verifyButton.addEventListener('click', verifyPassword);
            }

            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) {
                loginBtn.addEventListener('click', login);
            }

            const addScheduleBtn = document.getElementById('addScheduleBtn');
            if (addScheduleBtn) {
                addScheduleBtn.addEventListener('click', addSchedule);
            }

            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }

            const openDatePickerBtn = document.getElementById('openDatePickerBtn');
            if (openDatePickerBtn) {
                openDatePickerBtn.addEventListener('click', openCustomDatePicker);
            }

            const prevModalMonthBtn = document.getElementById('prevModalMonthBtn');
            if (prevModalMonthBtn) {
                prevModalMonthBtn.addEventListener('click', () => changeModalMonth(-1));
            }

            const nextModalMonthBtn = document.getElementById('nextModalMonthBtn');
            if (nextModalMonthBtn) {
                nextModalMonthBtn.addEventListener('click', () => changeModalMonth(1));
            }

            const confirmRangeBtn = document.getElementById('confirmRangeBtn');
            if (confirmRangeBtn) {
                confirmRangeBtn.addEventListener('click', confirmRangeSelection);
            }

            const closeDatePickerBtn = document.getElementById('closeDatePickerBtn');
            if (closeDatePickerBtn) {
                closeDatePickerBtn.addEventListener('click', closeCustomDatePicker);
            }

            const closeScheduleDetailBtn = document.getElementById('closeScheduleDetailBtn');
            if (closeScheduleDetailBtn) {
                closeScheduleDetailBtn.addEventListener('click', closeScheduleDetailModal);
            }

            const calendarViewBtn = document.getElementById('calendarViewBtn');
            if (calendarViewBtn) {
                calendarViewBtn.addEventListener('click', () => switchView('calendar'));
            }

            const timelineViewBtn = document.getElementById('timelineViewBtn');
            if (timelineViewBtn) {
                timelineViewBtn.addEventListener('click', () => switchView('timeline'));
            }

            const prevMonthBtn = document.getElementById('prevMonthBtn');
            if (prevMonthBtn) {
                prevMonthBtn.addEventListener('click', () => changeMonth(-1));
            }

            const nextMonthBtn = document.getElementById('nextMonthBtn');
            if (nextMonthBtn) {
                nextMonthBtn.addEventListener('click', () => changeMonth(1));
            }

            const toggleLogsBtn = document.getElementById('toggleLogsBtn');
            if (toggleLogsBtn) {
                toggleLogsBtn.addEventListener('click', toggleLogs);
            }

            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal);
                    }
                });
            });
        });

        // 打开模态框
        function openModal(modal) {
            modal.classList.add('show');
        }

        // 关闭模态框
        function closeModal(modal) {
            modal.classList.remove('show');
        }

        // 登录
        function login() {
            console.log("登录函数被调用");
            const username = document.getElementById('username').value;
            if (!username) {
                alert('请选择一个用户！');
                console.log("未选择用户");
                return;
            }

            currentUser = username;
            console.log("当前用户:", currentUser);
            document.getElementById('addedBy').value = currentUser;
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('scheduleForm').style.display = 'block';
            document.getElementById('scheduleList').style.display = 'block';
            document.getElementById('logList').style.display = 'block';
            cleanSystemSchedules();
        }

        // 登出
        function logout() {
            auth.signOut().then(() => {
                currentUser = null;
                localStorage.removeItem('accessVerified');
                document.getElementById('passwordContainer').style.display = 'block';
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('scheduleForm').style.display = 'none';
                document.getElementById('scheduleList').style.display = 'none';
                document.getElementById('logList').style.display = 'none';
                document.getElementById('username').value = '';
                console.log("已登出");
            }).catch((error) => {
                console.error("登出失败:", error);
                alert("登出失败: " + error.message);
            });
        }

        // 添加日程
        function addSchedule() {
            if (!currentUser) {
                alert('请先登录！');
                return;
            }
            const startDatetime = document.getElementById('datetimeDisplay').dataset.start;
            const endDatetime = document.getElementById('datetimeDisplay').dataset.end;
            const event = document.getElementById('event').value.trim();

            if (!startDatetime || !endDatetime || !event) {
                alert('请填写所有必填项！');
                return;
            }

            const startDate = new Date(startDatetime);
            const endDate = new Date(endDatetime);
            const now = new Date();
            if (startDate < now) {
                alert('开始时间不能早于当前时间！');
                return;
            }

            const newSchedule = {
                startDatetime: startDate.toISOString(),
                endDatetime: endDate.toISOString(),
                event: event,
                user: currentUser,
                completed: false
            };
            schedulesRef.push(newSchedule).then(() => {
                logAction('添加日程', `事件: ${event}, 时间: ${startDate.toLocaleString('zh-CN')} 至 ${endDate.toLocaleString('zh-CN')}`);
                document.getElementById('datetimeDisplay').value = '';
                document.getElementById('datetimeDisplay').dataset.start = '';
                document.getElementById('datetimeDisplay').dataset.end = '';
                document.getElementById('event').value = '';
            });
        }

        // 加载日程
        function loadSchedules() {
            console.log("加载日程数据");
            if (!schedulesRef) {
                console.error("schedulesRef 未定义，Firebase 初始化可能失败");
                alert("无法加载日程，Firebase 初始化失败！");
                return;
            }
            schedulesRef.on('value', (snapshot) => {
                schedules = [];
                const data = snapshot.val();
                console.log("加载的日程数据:", data);
                if (data) {
                    Object.keys(data).forEach(key => {
                        const schedule = data[key];
                        if (isValidDate(schedule.startDatetime) && isValidDate(schedule.endDatetime)) {
                            schedules.push({
                                id: key,
                                startDatetime: new Date(schedule.startDatetime),
                                endDatetime: new Date(schedule.endDatetime),
                                event: schedule.event,
                                user: schedule.user,
                                completed: schedule.completed
                            });
                        } else {
                            console.error(`Invalid date for schedule ${key}:`, schedule);
                        }
                    });
                }
                filterSchedules();
            }, (error) => {
                console.error('加载数据失败:', error);
                alert('加载日程失败，请检查网络或 Firebase 配置！');
            });
        }

        // 加载日志
        function loadLogs() {
            logsRef.on('value', (snapshot) => {
                logs = [];
                const data = snapshot.val();
                console.log("加载的日志数据:", data);
                if (data) {
                    Object.keys(data).forEach(key => {
                        logs.push({
                            id: key,
                            user: data[key].user,
                            action: data[key].action,
                            details: data[key].details,
                            timestamp: new Date(data[key].timestamp)
                        });
                    });
                }
                renderLogs();
            }, (error) => {
                console.error('加载日志失败:', error);
                if (error.code === 'PERMISSION_DENIED') {
                    alert('加载日志失败，请检查 Firebase 规则，当前用户无权限访问 /logs 节点。');
                } else {
                    alert('加载日志失败，请检查网络或 Firebase 配置: ' + error.message);
                }
            });
        }

        // 筛选日程
        function filterSchedules() {
            const filterUser = document.getElementById('filterUser').value;
            let filteredSchedules = schedules;

            if (filterUser !== 'all') {
                filteredSchedules = filteredSchedules.filter(schedule => schedule.user === filterUser);
            }
            console.log("筛选后的日程:", filteredSchedules);

            if (currentView === 'calendar') {
                renderCalendar(filteredSchedules);
            } else {
                renderTimeline(filteredSchedules);
            }
        }

        // 渲染时间线视图
        function renderTimeline(filteredSchedules) {
            const timeline = document.getElementById('timelineView');
            timeline.innerHTML = '';

            filteredSchedules.sort((a, b) => a.startDatetime - b.startDatetime);

            filteredSchedules.forEach((schedule, index) => {
                const startDate = schedule.startDatetime;
                const endDate = schedule.endDatetime;

                const startFormatted = isValidDate(startDate) ? startDate.toLocaleString('zh-CN', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit',
                    weekday: 'long',
                    timeZone: 'Asia/Shanghai'
                }) : '未知日期';
                const endFormatted = isValidDate(endDate) ? endDate.toLocaleString('zh-CN', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit',
                    weekday: 'long',
                    timeZone: 'Asia/Shanghai'
                }) : '未知日期';

                const avatar = {
                    '吴乐乐': { color: '#e74c3c', initial: '吴' },
                    '张宝宝': { color: '#2ecc71', initial: '张' },
                    '冯妈妈': { color: '#3498db', initial: '冯' },
                    '懒宝': { color: '#f1c40f', initial: '懒' }
                }[schedule.user] || { color: '#95a5a6', initial: schedule.user[0] };

                const timelineItem = document.createElement('div');
                timelineItem.className = `timeline-item ${schedule.completed ? 'completed' : ''}`;
                timelineItem.innerHTML = `
                    <div class="avatar" style="background-color: ${avatar.color}">${avatar.initial}</div>
                    <div class="content">
                        <div class="date-time">${startFormatted} 至 ${endFormatted}</div>
                        <div class="event">事件: ${schedule.event}</div>
                        <div class="added-by">添加者: ${schedule.user}</div>
                    </div>
                    <div class="actions">
                        <input type="checkbox" class="checkbox" ${schedule.completed ? 'checked' : ''} onchange="toggleComplete('${schedule.id}', this)">
                        <button class="delete-btn" data-id="${schedule.id}" data-event="${schedule.event}" data-datetime="${startFormatted} 至 ${endFormatted}"><i class="fas fa-trash-alt"></i> 删除</button>
                    </div>
                `;
                timeline.appendChild(timelineItem);

                timelineItem.addEventListener('click', (e) => {
                    if (!e.target.closest('.actions')) {
                        openScheduleDetailModal(schedule);
                    }
                });

                const deleteBtn = timelineItem.querySelector('.delete-btn');
                deleteBtn.addEventListener('click', () => {
                    const id = deleteBtn.dataset.id;
                    const event = deleteBtn.dataset.event;
                    const datetime = deleteBtn.dataset.datetime;
                    deleteSchedule(id, event, datetime);
                });
            });
        }

        // 切换完成状态
        function toggleComplete(id, checkbox) {
            const schedule = schedules.find(s => s.id === id);
            if (schedule) {
                schedulesRef.child(id).update({ completed: checkbox.checked }).then(() => {
                    logAction('更新日程状态', `事件: ${schedule.event}, 状态: ${checkbox.checked ? '已完成' : '未完成'}`);
                });
            }
        }

        // 删除日程
        function deleteSchedule(id, event, datetime) {
            console.log("deleteSchedule 被调用", id, event, datetime);
            if (confirm(`确定要删除日程 "${event}" (${datetime}) 吗？`)) {
                schedulesRef.child(id).remove().then(() => {
                    logAction('删除日程', `事件: ${event}, 时间: ${datetime}`);
                });
            }
        }

        // 切换视图
        function switchView(view) {
            console.log("switchView 被调用", view);
            currentView = view;
            document.getElementById('calendarView').style.display = view === 'calendar' ? 'block' : 'none';
            document.getElementById('timelineView').style.display = view === 'timeline' ? 'block' : 'none';
            document.getElementById('calendarViewBtn').classList.toggle('active', view === 'calendar');
            document.getElementById('timelineViewBtn').classList.toggle('active', view === 'timeline');
            filterSchedules();
        }

        // 更改月份
        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            filterSchedules();
        }

        // 渲染日历视图
        function renderCalendar(filteredSchedules) {
            const calendarGrid = document.getElementById('calendarGrid');
            const calendarMonth = document.getElementById('calendarMonth');
            calendarGrid.innerHTML = '';

            calendarMonth.textContent = `${currentMonth.getFullYear()}年 ${currentMonth.getMonth() + 1}月`;

            const daysOfWeek = ['日', '一', '二', '三', '四', '五', '六'];
            daysOfWeek.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });

            const firstDayOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const lastDayOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
            const startDay = firstDayOfMonth.getDay();
            const today = new Date();

            // 创建日历格子
            for (let i = 0; i < startDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                calendarGrid.appendChild(emptyDay);
            }

            // 为每一天创建格子
            const dayElements = [];
            for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
                const currentDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day);
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                if (currentDate.getDate() === today.getDate() &&
                    currentDate.getMonth() === today.getMonth() &&
                    currentDate.getFullYear() === today.getFullYear()) {
                    dayDiv.classList.add('today');
                }

                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayDiv.appendChild(dayNumber);

                calendarGrid.appendChild(dayDiv);
                dayElements[day] = dayDiv; // 保存每个日期的 DOM 元素
            }

            // 遍历所有日程，检查每个日程的时间范围
            filteredSchedules.forEach(schedule => {
                const startDate = new Date(schedule.startDatetime);
                const endDate = new Date(schedule.endDatetime);

                // 确保日程在当前月份内
                const start = new Date(Math.max(startDate, firstDayOfMonth));
                const end = new Date(Math.min(endDate, lastDayOfMonth));

                // 如果日程的结束时间早于当前月份的开始时间，或者开始时间晚于当前月份的结束时间，则跳过
                if (end < firstDayOfMonth || start > lastDayOfMonth) {
                    return;
                }

                // 遍历日程覆盖的每一天
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    const day = d.getDate();
                    if (d.getMonth() === currentMonth.getMonth() && d.getFullYear() === currentMonth.getFullYear()) {
                        const dayDiv = dayElements[day];
                        if (dayDiv) {
                            const eventDiv = document.createElement('div');
                            eventDiv.className = `calendar-event ${schedule.completed ? 'completed' : ''}`;
                            const avatar = {
                                '吴乐乐': { color: '#e74c3c', initial: '吴' },
                                '张宝宝': { color: '#2ecc71', initial: '张' },
                                '冯妈妈': { color: '#3498db', initial: '冯' },
                                '懒宝': { color: '#f1c40f', initial: '懒' }
                            }[schedule.user] || { color: '#95a5a6', initial: schedule.user[0] };

                            eventDiv.innerHTML = `
                                <div class="avatar" style="background-color: ${avatar.color}">${avatar.initial}</div>
                                <div class="content">
                                    <div class="event-text">${schedule.event}</div>
                                    <div class="added-by">添加者: ${schedule.user}</div>
                                </div>
                            `;
                            eventDiv.addEventListener('click', () => openScheduleDetailModal(schedule));
                            dayDiv.appendChild(eventDiv);
                        }
                    }
                }
            });
        }

        // 打开自定义日期选择器
        function openCustomDatePicker() {
            console.log("openCustomDatePicker 被调用");
            const modal = document.getElementById('datePickerModal');
            modalStartMonth = new Date();
            modalIsSelecting = false;
            modalSelectedStart = null;
            modalSelectedEnd = null;
            renderModalCalendar();
            openModal(modal);
        }

        // 关闭自定义日期选择器
        function closeCustomDatePicker() {
            console.log("closeCustomDatePicker 被调用");
            const modal = document.getElementById('datePickerModal');
            closeModal(modal);
            modalIsSelecting = false;
            modalSelectedStart = null;
            modalSelectedEnd = null;
            document.querySelectorAll('.calendar-day').forEach(day => day.classList.remove('selected'));
        }

        // 打开日程详情模态框
        function openScheduleDetailModal(schedule) {
            console.log("openScheduleDetailModal 被调用", schedule);
            const modal = document.getElementById('scheduleDetailModal');
            const content = document.getElementById('scheduleDetailContent');
            const startDate = new Date(schedule.startDatetime);
            const endDate = new Date(schedule.endDatetime);
            const avatar = {
                '吴乐乐': { color: '#e74c3c', initial: '吴' },
                '张宝宝': { color: '#2ecc71', initial: '张' },
                '冯妈妈': { color: '#3498db', initial: '冯' },
                '懒宝': { color: '#f1c40f', initial: '懒' }
            }[schedule.user] || { color: '#95a5a6', initial: schedule.user[0] };

            const startFormatted = startDate.toLocaleString('zh-CN', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit',
                timeZone: 'Asia/Shanghai'
            });
            const endFormatted = endDate.toLocaleString('zh-CN', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit',
                timeZone: 'Asia/Shanghai'
            });

            content.innerHTML = `
                <div class="detail-item ${schedule.completed ? 'completed' : ''}">
                    <div class="avatar" style="background-color: ${avatar.color}">${avatar.initial}</div>
                    <div class="content">
                        <div class="time-range">${startFormatted} 至 ${endFormatted}</div>
                        <div class="event-text">事件: ${schedule.event}</div>
                        <div class="added-by">添加者: ${schedule.user}</div>
                    </div>
                </div>
                <div class="actions">
                    <input type="checkbox" class="checkbox" ${schedule.completed ? 'checked' : ''} onchange="toggleComplete('${schedule.id}', this)">
                    <button class="delete-btn" data-id="${schedule.id}" data-event="${schedule.event}" data-datetime="${startFormatted} 至 ${endFormatted}"><i class="fas fa-trash-alt"></i> 删除</button>
                </div>
            `;
            openModal(modal);

            const deleteBtn = content.querySelector('.delete-btn');
            deleteBtn.addEventListener('click', () => {
                const id = deleteBtn.dataset.id;
                const event = deleteBtn.dataset.event;
                const datetime = deleteBtn.dataset.datetime;
                deleteSchedule(id, event, datetime);
            });
        }

        // 关闭日程详情模态框
        function closeScheduleDetailModal() {
            console.log("closeScheduleDetailModal 被调用");
            const modal = document.getElementById('scheduleDetailModal');
            closeModal(modal);
        }

        // 切换模态框月份
        function changeModalMonth(delta) {
            console.log("changeModalMonth 被调用", delta);
            modalStartMonth.setMonth(modalStartMonth.getMonth() + delta);
            renderModalCalendar();
        }

        // 渲染模态框日历
        function renderModalCalendar() {
            console.log("renderModalCalendar 被调用");
            const calendarGrid = document.getElementById('modalCalendarGrid');
            calendarGrid.innerHTML = '';

            const monthsToShow = 2;
            const today = new Date();

            for (let i = 0; i < monthsToShow; i++) {
                const currentMonth = new Date(modalStartMonth.getFullYear(), modalStartMonth.getMonth() + i, 1);
                const monthDiv = document.createElement('div');
                monthDiv.className = 'calendar-month';

                const monthTitle = document.createElement('h4');
                monthTitle.textContent = `${currentMonth.getFullYear()}年 ${currentMonth.getMonth() + 1}月`;
                monthDiv.appendChild(monthTitle);

                const monthGrid = document.createElement('div');
                monthGrid.className = 'calendar-grid';
                monthDiv.appendChild(monthGrid);

                const daysOfWeek = ['日', '一', '二', '三', '四', '五', '六'];
                daysOfWeek.forEach(day => {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'calendar-day header';
                    dayHeader.textContent = day;
                    monthGrid.appendChild(dayHeader);
                });

                const firstDayOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
                const lastDayOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
                const startDay = firstDayOfMonth.getDay();

                for (let j = 0; j < startDay; j++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'calendar-day empty';
                    monthGrid.appendChild(emptyDay);
                }

                for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
                    const currentDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day);
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day';
                    dayDiv.dataset.date = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    if (currentDate.getDate() === today.getDate() &&
                        currentDate.getMonth() === today.getMonth() &&
                        currentDate.getFullYear() === today.getFullYear()) {
                        dayDiv.classList.add('today');
                    }
                    dayDiv.textContent = day;
                    monthGrid.appendChild(dayDiv);
                }

                calendarGrid.appendChild(monthDiv);
            }

            highlightRange();

            calendarGrid.removeEventListener('mousedown', startSelection);
            calendarGrid.removeEventListener('mouseover', updateSelection);
            calendarGrid.removeEventListener('mouseup', endSelection);
            calendarGrid.removeEventListener('touchstart', startTouchSelection);
            calendarGrid.removeEventListener('touchmove', updateTouchSelection);
            calendarGrid.removeEventListener('touchend', endTouchSelection);

            calendarGrid.addEventListener('mousedown', startSelection);
            calendarGrid.addEventListener('mouseover', updateSelection);
            calendarGrid.addEventListener('mouseup', endSelection);
            calendarGrid.addEventListener('touchstart', startTouchSelection, { passive: false });
            calendarGrid.addEventListener('touchmove', updateTouchSelection, { passive: false });
            calendarGrid.addEventListener('touchend', endTouchSelection, { passive: false });
        }

        // 开始选择
        function startSelection(e) {
            const day = e.target.closest('.calendar-day:not(.empty):not(.header)');
            if (day) {
                modalIsSelecting = true;
                modalSelectedStart = day.dataset.date;
                modalSelectedEnd = day.dataset.date;
                highlightRange();
            }
        }

        // 更新选择
        function updateSelection(e) {
            if (modalIsSelecting) {
                const day = e.target.closest('.calendar-day:not(.empty):not(.header)');
                if (day) {
                    modalSelectedEnd = day.dataset.date;
                    highlightRange();
                }
            }
        }

        // 结束选择
        function endSelection() {
            modalIsSelecting = false;
        }

        // 开始触摸选择
        function startTouchSelection(e) {
            e.preventDefault();
            const day = e.target.closest('.calendar-day:not(.empty):not(.header)');
            if (day) {
                modalIsSelecting = true;
                modalSelectedStart = day.dataset.date;
                modalSelectedEnd = day.dataset.date;
                highlightRange();
            }
        }

        // 更新触摸选择
        function updateTouchSelection(e) {
            e.preventDefault();
            if (modalIsSelecting) {
                const touch = e.touches[0];
                const element = document.elementFromPoint(touch.clientX, touch.clientY);
                const day = element.closest('.calendar-day:not(.empty):not(.header)');
                if (day) {
                    modalSelectedEnd = day.dataset.date;
                    highlightRange();
                }
            }
        }

        // 结束触摸选择
        function endTouchSelection(e) {
            e.preventDefault();
            modalIsSelecting = false;
        }

        // 高亮选择范围
        function highlightRange() {
            const days = document.querySelectorAll('#modalCalendarGrid .calendar-day');
            let startDate = modalSelectedStart ? new Date(modalSelectedStart) : null;
            let endDate = modalSelectedEnd ? new Date(modalSelectedEnd) : null;

            if (startDate && endDate && startDate > endDate) {
                [startDate, endDate] = [endDate, startDate];
                [modalSelectedStart, modalSelectedEnd] = [modalSelectedEnd, modalSelectedStart];
            }

            days.forEach(day => {
                day.classList.remove('selected');
                const dayDate = day.dataset.date ? new Date(day.dataset.date) : null;
                if (dayDate && startDate && endDate) {
                    if (dayDate >= startDate && dayDate <= endDate) {
                        day.classList.add('selected');
                    }
                }
            });
        }

        // 确认选择范围
        function confirmRangeSelection() {
            if (!modalSelectedStart || !modalSelectedEnd) {
                alert('请选择一个时间范围！');
                return;
            }

            let startDate = new Date(modalSelectedStart);
            let endDate = new Date(modalSelectedEnd);

            if (startDate > endDate) {
                [startDate, endDate] = [endDate, startDate];
            }

            const now = new Date();
            if (startDate < now) {
                alert('开始时间不能早于当前时间！');
                return;
            }

            const startFormatted = startDate.toLocaleString('zh-CN', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });
            const endFormatted = endDate.toLocaleString('zh-CN', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });

            startDate.setHours(9, 0, 0, 0);
            endDate.setHours(10, 0, 0, 0);

            document.getElementById('datetimeDisplay').value = `${startFormatted} 至 ${endFormatted}`;
            document.getElementById('datetimeDisplay').dataset.start = startDate.toISOString();
            document.getElementById('datetimeDisplay').dataset.end = endDate.toISOString();

            closeCustomDatePicker();
        }

        // 渲染日志
        function renderLogs() {
            const logsContainer = document.getElementById('logs');
            const toggleBtn = document.getElementById('toggleLogsBtn');
            logsContainer.innerHTML = '';
            logs.sort((a, b) => b.timestamp - a.timestamp);
            console.log("渲染的日志:", logs);

            logs.forEach(log => {
                const logItem = document.createElement('div');
                logItem.className = 'log-item';
                logItem.innerHTML = `${log.timestamp.toLocaleString('zh-CN')} - ${log.user} ${log.action}: ${log.details}`;
                logsContainer.appendChild(logItem);
            });

            if (logs.length > 5) {
                toggleBtn.style.display = 'inline-flex';
                if (!isLogsExpanded) {
                    logsContainer.classList.add('collapsed');
                    toggleBtn.innerHTML = '<i class="fas fa-chevron-down"></i> 查看更多';
                } else {
                    logsContainer.classList.remove('collapsed');
                    toggleBtn.innerHTML = '<i class="fas fa-chevron-up"></i> 收起';
                }
            } else {
                toggleBtn.style.display = 'none';
                logsContainer.classList.remove('collapsed');
            }
        }

        // 切换日志展开/收起
        function toggleLogs() {
            const logsContainer = document.getElementById('logs');
            const toggleBtn = document.getElementById('toggleLogsBtn');
            isLogsExpanded = !isLogsExpanded;
            if (isLogsExpanded) {
                logsContainer.classList.remove('collapsed');
                toggleBtn.innerHTML = '<i class="fas fa-chevron-up"></i> 收起';
            } else {
                logsContainer.classList.add('collapsed');
                toggleBtn.innerHTML = '<i class="fas fa-chevron-down"></i> 查看更多';
            }
        }

        // 记录操作日志
        function logAction(action, details) {
            const logEntry = {
                user: currentUser || '未知用户',
                action: action,
                details: details,
                timestamp: new Date().toISOString()
            };
            logsRef.push(logEntry);
        }
    </script>
</body>
</html>
